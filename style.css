// MeuBolso - Script principal
document.addEventListener('DOMContentLoaded', function() {
  // Elementos DOM
  const voiceButton = document.getElementById('voiceButton');
  const voiceStatus = document.getElementById('voiceStatus');
  const resultCard = document.getElementById('resultCard');
  const recognizedValue = document.getElementById('recognizedValue');
  const recognizedCategory = document.getElementById('recognizedCategory');
  const confirmBtn = document.getElementById('confirmBtn');
  const retryBtn = document.getElementById('retryBtn');
  const debugText = document.getElementById('debugText');
  const transactionsList = document.getElementById('transactionsList');
  
  // Inicializar hist√≥rico de transa√ß√µes do localStorage
  let transactions = JSON.parse(localStorage.getItem('meuBolsoTransactions')) || [];
  
  // Categorias reconhecidas
  const categories = {
    'alimenta√ß√£o': 'üçΩÔ∏è Alimenta√ß√£o',
    'alimentacao': 'üçΩÔ∏è Alimenta√ß√£o',
    'comida': 'üçΩÔ∏è Alimenta√ß√£o',
    'restaurante': 'üçΩÔ∏è Alimenta√ß√£o',
    'lanche': 'üçΩÔ∏è Alimenta√ß√£o',
    'transporte': '‚õΩ Transporte',
    'uber': '‚õΩ Transporte',
    'taxi': '‚õΩ Transporte',
    't√°xi': '‚õΩ Transporte',
    'combust√≠vel': '‚õΩ Transporte',
    'combustivel': '‚õΩ Transporte',
    'gasolina': '‚õΩ Transporte',
    '√¥nibus': '‚õΩ Transporte',
    'onibus': '‚õΩ Transporte',
    'lazer': 'üé¨ Lazer',
    'cinema': 'üé¨ Lazer',
    'teatro': 'üé¨ Lazer',
    'show': 'üé¨ Lazer',
    'supermercado': 'üõí Supermercado',
    'mercado': 'üõí Supermercado',
    'compras': 'üõí Supermercado',
    'moradia': 'üè† Moradia',
    'aluguel': 'üè† Moradia',
    'casa': 'üè† Moradia',
    'condom√≠nio': 'üè† Moradia',
    'condominio': 'üè† Moradia',
    'sa√∫de': 'üíä Sa√∫de',
    'saude': 'üíä Sa√∫de',
    'rem√©dio': 'üíä Sa√∫de',
    'remedio': 'üíä Sa√∫de',
    'farm√°cia': 'üíä Sa√∫de',
    'farmacia': 'üíä Sa√∫de',
    'm√©dico': 'üíä Sa√∫de',
    'medico': 'üíä Sa√∫de',
    'roupa': 'üëï Vestu√°rio',
    'roupas': 'üëï Vestu√°rio',
    'vestu√°rio': 'üëï Vestu√°rio',
    'vestuario': 'üëï Vestu√°rio'
  };
  
  // Cores das categorias
  const categoryColors = {
    'üçΩÔ∏è Alimenta√ß√£o': '#E91E63',
    '‚õΩ Transporte': '#673AB7',
    'üé¨ Lazer': '#8BC34A',
    'üõí Supermercado': '#FF9800',
    'üè† Moradia': '#009688',
    'üíä Sa√∫de': '#F44336',
    'üëï Vestu√°rio': '#3F51B5',
    'Outros': '#607D8B'
  };
  
  // Verificar suporte a reconhecimento de voz
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition;
  
  if (!SpeechRecognition) {
    voiceStatus.textContent = "Seu navegador n√£o suporta reconhecimento de voz";
    voiceButton.classList.add('disabled');
    debugText.textContent = "Tente usar o Chrome, Edge ou Safari para usar o reconhecimento de voz.";
    resultCard.classList.remove('hidden');
  } else {
    recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    let isListening = false;
    
    // Iniciar/parar reconhecimento
    voiceButton.addEventListener('click', () => {
      if (isListening) {
        stopListening();
      } else {
        startListening();
      }
    });
    
    function startListening() {
      resultCard.classList.add('hidden');
      try {
        recognition.start();
        voiceButton.classList.add('listening');
        voiceStatus.textContent = 'Ouvindo...';
        isListening = true;
      } catch (error) {
        console.error('Erro ao iniciar reconhecimento:', error);
        voiceStatus.textContent = 'Erro ao iniciar. Tente novamente.';
        debugText.textContent = `Erro: ${error.message}`;
        resultCard.classList.remove('hidden');
      }
    }
    
    function stopListening() {
      recognition.stop();
      voiceButton.classList.remove('listening');
      voiceStatus.textContent = 'Toque para falar';
      isListening = false;
    }
    
    // Processar resultado
    recognition.onresult = (event) => {
      const speechResult = event.results[0][0].transcript.toLowerCase();
      console.log('Fala reconhecida:', speechResult);
      
      // Para fins de debug
      debugText.textContent = `Texto reconhecido: "${speechResult}"`;
      
      // Processar o texto reconhecido
      const processedResult = processVoiceInput(speechResult);
      
      // Exibir resultado
      recognizedValue.textContent = `R$ ${processedResult.formattedAmount}`;
      recognizedCategory.textContent = processedResult.category;
      resultCard.classList.remove('hidden');
      
      // Resetar estado
      stopListening();
    };
    
    // Tratamento de erros
    recognition.onerror = (event) => {
      console.error('Erro de reconhecimento:', event.error);
      voiceButton.classList.remove('listening');
      voiceStatus.textContent = 'Erro. Tente novamente';
      isListening = false;
      
      // Mostrar erro para debug
      debugText.textContent = `Erro: ${event.error}`;
      resultCard.classList.remove('hidden');
    };
    
    // Fim do reconhecimento
    recognition.onend = () => {
      if (isListening) {
        stopListening();
      }
    };
    
    // Bot√µes de confirma√ß√£o e nova tentativa
    confirmBtn.addEventListener('click', () => {
      const value = recognizedValue.textContent.replace('R$ ', '');
      const category = recognizedCategory.textContent;
      
      // Criar nova transa√ß√£o
      const newTransaction = {
        id: Date.now(),
        amount: parseFloat(value.replace(',', '.')),
        category: category,
        date: new Date().toISOString(),
        description: debugText.textContent.replace('Texto reconhecido: "', '').replace('"', '')
      };
      
      // Adicionar ao hist√≥rico
      transactions.unshift(newTransaction);
      
      // Limitar a 10 transa√ß√µes para simplificar
      if (transactions.length > 10) {
        transactions = transactions.slice(0, 10);
      }
      
      // Salvar no localStorage
      localStorage.setItem('meuBolsoTransactions', JSON.stringify(transactions));
      
      // Atualizar a interface
      updateTransactionsList();
      
      // Feedback
      alert('Transa√ß√£o registrada com sucesso!');
      resultCard.classList.add('hidden');
    });
    
    retryBtn.addEventListener('click', () => {
      resultCard.classList.add('hidden');
      startListening();
    });
  }
  
  // Fun√ß√£o para processar texto de entrada por voz
  function processVoiceInput(voiceText) {
    console.log('Processando entrada de voz:', voiceText);
    
    // Padr√µes de valores a serem reconhecidos:
    // 1. N√∫meros seguidos por "reais" ou "real" - ex: "50 reais"
    // 2. N√∫meros com "e" para centavos - ex: "32 e 50"
    // 3. N√∫meros com v√≠rgula ou ponto - ex: "45,90" ou "45.90"
    // 4. Apenas n√∫meros - ex: "100"
    
    // Tentar padr√£o "X reais/real"
    let valueMatch = voiceText.match(/(\d+)[.,]?(\d*)\s*(reais|real)/i);
    
    // Se n√£o encontrou, tentar padr√£o "X e Y" (para reais e centavos)
    if (!valueMatch) {
      valueMatch = voiceText.match(/(\d+)\s+e\s+(\d+)/i);
      if (valueMatch) {
        // Converter para formato decimal (X.Y)
        valueMatch[2] = valueMatch[2].padEnd(2, '0').substring(0, 2);
      }
    }
    
    // Se n√£o encontrou, tentar padr√£o "X v√≠rgula/ponto Y"
    if (!valueMatch) {
      valueMatch = voiceText.match(/(\d+)[,.](\d+)/i);
    }
    
    // Se n√£o encontrou, procurar por qualquer n√∫mero
    if (!valueMatch) {
      valueMatch = voiceText.match(/(\d+)/i);
      if (valueMatch) {
        valueMatch[2] = "00"; // Adicionar centavos zero
      }
    }
    
    let amount = 0;
    let formattedAmount = '0,00';
    let missingValue = false;
    
    if (valueMatch) {
      const integerPart = valueMatch[1];
      const decimalPart = valueMatch[2] || '00';
      formattedAmount = `${integerPart},${decimalPart.padEnd(2, '0').substring(0, 2)}`;
      amount = parseFloat(`${integerPart}.${decimalPart.padEnd(2, '0').substring(0, 2)}`);
    } else {
      missingValue = true;
    }
    
    // Extrair categoria
    let category = 'Outros';
    let missingCategory = true;
    let confidence = 0.5;
    
    for (const [key, displayName] of Object.entries(categories)) {
      if (voiceText.includes(key)) {
        category = displayName;
        missingCategory = false;
        confidence = 0.9;
        break;
      }
    }
    
    return {
      amount,
      formattedAmount,
      category,
      confidence,
      missingValue,
      missingCategory,
      isIncomplete: missingValue || missingCategory,
      rawText: voiceText
    };
  }
  
  // Fun√ß√£o para atualizar a lista de transa√ß√µes
  function updateTransactionsList() {
    if (transactions.length === 0) {
      transactionsList.innerHTML = '<p class="empty-state">Suas transa√ß√µes aparecer√£o aqui</p>';
      return;
    }
    
    transactionsList.innerHTML = '';
    
    transactions.forEach(transaction => {
      const date = new Date(transaction.date);
      const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
      
      const transactionItem = document.createElement('div');
      transactionItem.className = 'transaction-item';
      
      const isPositive = transaction.amount > 0;
      const amountClass = isPositive ? 'amount-positive' : 'amount-negative';
      const amountSign = isPositive ? '+' : '-';
      const amountValue = Math.abs(transaction.amount).toFixed(2).replace('.', ',');
      
      const categoryColor = categoryColors[transaction.category] || categoryColors['Outros'];
      
      transactionItem.innerHTML = `
        <div class="transaction-info">
          <div class="transaction-category" style="background-color: ${categoryColor}">
            ${transaction.category.split(' ')[0]}
          </div>
          <div class="transaction-details">
            <div class="transaction-name">${transaction.category.split(' ')[1] || 'Outros'}</div>
            <div class="transaction-date">${formattedDate}</div>
          </div>
        </div>
        <div class="transaction-amount ${amountClass}">${amountSign}R$ ${amountValue}</div>
      `;
      
      transactionsList.appendChild(transactionItem);
    });
  }
  
  // Inicializar a lista de transa√ß√µes
  updateTransactionsList();
});
